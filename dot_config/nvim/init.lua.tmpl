{{- if eq .distro "arch" -}}
-- ============================================================
-- Basic options
-- ============================================================
vim.g.mapleader = " "
vim.opt.encoding = "utf-8"
vim.opt.hidden = true
vim.opt.backup = false
vim.opt.writebackup = false
vim.opt.cmdheight = 2
vim.opt.updatetime = 300
vim.opt.shortmess:append("c")
vim.opt.number = true

vim.opt.tabstop = 2
vim.opt.shiftwidth = 2
vim.opt.expandtab = true

vim.opt.hlsearch = true
vim.opt.list = true
vim.opt.listchars = { tab = ">-" }
vim.opt.wrap = false
vim.opt.mouse = "v"

vim.opt.errorbells = false
vim.opt.visualbell = false
vim.opt.belloff = "all"

vim.opt.termguicolors = true
vim.opt.clipboard = "unnamedplus"
vim.opt.signcolumn = "auto"

-- ============================================================
-- Keymaps
-- ============================================================
local map = vim.keymap.set

map("n", "<F7>",  "<cmd>enew<CR>", { silent = true })
map("n", "<F8>",  "<cmd>bprevious<CR>", { silent = true })
map("n", "<F9>",  "<cmd>bnext<CR>", { silent = true })
map("n", "<F10>", "<cmd>bp | bd #<CR>", { silent = true })

map("n", "<Space>", "<cmd>nohlsearch<CR>", { silent = true })
map("n", "ä", "<cmd>silent! %yank +<CR>", { silent = true })

-- ============================================================
-- Plugins: lazy.nvim bootstrap
-- ============================================================
local lazypath = vim.fn.stdpath("data") .. "/lazy/lazy.nvim"
if not vim.loop.fs_stat(lazypath) then
  vim.fn.system({
    "git", "clone", "--filter=blob:none",
    "https://github.com/folke/lazy.nvim.git",
    "--branch=stable",
    lazypath
  })
end
vim.opt.rtp:prepend(lazypath)

-- ============================================================
-- Plugins
-- ============================================================
require("lazy").setup({
  {
    "nvim-tree/nvim-tree.lua",
    dependencies = { "nvim-tree/nvim-web-devicons" },
    config = function()
      require("nvim-tree").setup({
        view = { width = 60 },
        filters = { dotfiles = false },
        git = { enable = true },
        actions = { open_file = { quit_on_open = true } },
      })
    end,
  },

  {
    "nvim-lualine/lualine.nvim",
    dependencies = { "nvim-tree/nvim-web-devicons" },
    config = function()
      require("lualine").setup({ options = { icons_enabled = true } })
    end,
  },

  { "rose-pine/neovim", name = "rose-pine", lazy = false, priority = 1000 },
  { "maxmx03/solarized.nvim", lazy = false, priority = 1000 },

  { "alker0/chezmoi.vim", lazy = false },

  -- LSP + mason
  { "neovim/nvim-lspconfig" },
  { "williamboman/mason.nvim", config = function() require("mason").setup() end },
  {
    "williamboman/mason-lspconfig.nvim",
    config = function()
      require("mason-lspconfig").setup({
        ensure_installed = { "pyright", "clangd", "yamlls", "dockerls" },
      })
    end,
  },

  { "nvim-telescope/telescope.nvim", dependencies = { "nvim-lua/plenary.nvim" } },
  { "numToStr/Comment.nvim", config = function() require("Comment").setup() end },

  { "hrsh7th/nvim-cmp" },
  { "hrsh7th/cmp-nvim-lsp" },
  { "L3MON4D3/LuaSnip" },
  { "rafamadriz/friendly-snippets" },
  {'romgrk/barbar.nvim',
    dependencies = {
      'lewis6991/gitsigns.nvim', -- OPTIONAL: for git status
      'nvim-tree/nvim-web-devicons', -- OPTIONAL: for file icons
    },
    init = function() vim.g.barbar_auto_setup = false end,
    opts = {
      -- lazy.nvim will automatically call setup for you. put your options here, anything missing will use the default:
      -- animation = true,
      -- insert_at_start = true,
      -- …etc.
    },
    version = '^1.0.0', -- optional: only update when a new 1.x version is released
  },
})

-- ============================================================
-- Cheat Sheet
-- ============================================================
vim.api.nvim_create_autocmd("VimEnter", {
  callback = function()
    if vim.fn.argc() == 0 then
      vim.cmd("edit ~/.config/nvim/cheatsheet.md")
    end
  end,
})

-- ============================================================
-- Theme
-- ============================================================
require("solarized").setup({ variant = "dark" })
vim.cmd.colorscheme("solarized")
vim.o.background = "dark"

vim.api.nvim_set_hl(0, "Normal",   { bg = "#002b36", fg = "#839496" })
vim.api.nvim_set_hl(0, "NormalNC", { bg = "#002b36" })
vim.api.nvim_set_hl(0, "Visual",   { bg = "#586e75", fg = "#002b36" })
vim.api.nvim_set_hl(0, "VisualNOS",{ bg = "#586e75", fg = "#002b36" })
vim.api.nvim_set_hl(0, "Cursor",   { fg = "#002b36", bg = "#93a1a1" })

-- ============================================================
-- LSP 
-- ============================================================
local on_attach = function(_, bufnr)
  local km = function(keys, func, desc)
    vim.keymap.set("n", keys, func, { buffer = bufnr, silent = true, desc = desc })
  end

  km("gd", vim.lsp.buf.definition, "Go to definition")
  km("gD", vim.lsp.buf.declaration, "Go to declaration")
  km("gi", vim.lsp.buf.implementation, "Go to implementation")
  km("gr", vim.lsp.buf.references, "Find references")

  local ok_tb, tb = pcall(require, "telescope.builtin")
  if ok_tb then
    km("<leader>ds", tb.lsp_document_symbols, "Document symbols")
    km("<leader>ws", tb.lsp_workspace_symbols, "Workspace symbols")
  end
end

local v = vim.version()
local is_nvim_011_or_newer = (v.major > 0) or (v.major == 0 and v.minor >= 11)

if is_nvim_011_or_newer then
  vim.lsp.config("pyright", { on_attach = on_attach })
  vim.lsp.config("clangd",  { on_attach = on_attach })
  vim.lsp.config("dockerls",{ on_attach = on_attach })
  vim.lsp.config("yamlls", {
    on_attach = on_attach,
    settings = {
      yaml = {
        schemas = {
          ["https://json.schemastore.org/github-workflow.json"] = "/.github/workflows/*",
        },
      },
    },
  })

  if type(vim.lsp.enable) == "function" then
    vim.lsp.enable({ "pyright", "clangd", "yamlls", "dockerls" })
  else
    vim.notify("vim.lsp.enable missing on Neovim >=0.11; LSP servers may not start automatically", vim.log.levels.WARN)
  end
else
  local ok, lspconfig = pcall(require, "lspconfig")
  if not ok then
    vim.notify("nvim-lspconfig missing on older Neovim", vim.log.levels.ERROR)
  else
    lspconfig.pyright.setup({ on_attach = on_attach })
    lspconfig.clangd.setup({ on_attach = on_attach })
    lspconfig.dockerls.setup({ on_attach = on_attach })
    lspconfig.yamlls.setup({
      on_attach = on_attach,
      settings = {
        yaml = {
          schemas = {
            ["https://json.schemastore.org/github-workflow.json"] = "/.github/workflows/*",
          },
        },
      },
    })
  end
end

-- ============================================================
-- CMP: Autocomplete Setup
-- ============================================================
local ok_cmp, cmp = pcall(require, "cmp")
if ok_cmp then
  local ok_luasnip, luasnip = pcall(require, "luasnip")
  if ok_luasnip then
    pcall(function() require("luasnip.loaders.from_vscode").lazy_load() end)
  end

  cmp.setup({
    snippet = {
      expand = function(args)
        if ok_luasnip then
          luasnip.lsp_expand(args.body)
        end
      end,
    },
    mapping = cmp.mapping.preset.insert({
      ["<C-Space>"] = cmp.mapping.complete(),
      ["<CR>"]      = cmp.mapping.confirm({ select = true }),
      ["<Tab>"]     = cmp.mapping.select_next_item(),
      ["<S-Tab>"]   = cmp.mapping.select_prev_item(),
    }),
    sources = {
      { name = "nvim_lsp" },
    },
  })
end

-- ============================================================
-- nvim-tree toggle
-- ============================================================
local function my_tree_toggle()
  local ft = vim.bo.filetype
  if ft == "NvimTree" then
    vim.cmd("NvimTreeToggle")
  else
    vim.cmd("NvimTreeFindFile")
  end
end
vim.keymap.set("n", "<C-n>", my_tree_toggle, { silent = true })

-- ============================================================
-- Comment madness deactivated
-- ============================================================
vim.api.nvim_create_autocmd("FileType", {
  pattern = "*",
  callback = function()
    vim.opt_local.formatoptions:remove({ "r", "o" })
  end,
})

{{- else if eq .distro "ubuntu" -}}
-- ============================================================
-- Basic options 
-- ============================================================
vim.g.mapleader = " "
vim.opt.encoding = "utf-8"
vim.opt.hidden = true
vim.opt.backup = false
vim.opt.writebackup = false
vim.opt.cmdheight = 2
vim.opt.updatetime = 300
vim.opt.shortmess:append("c")
vim.opt.number = true

vim.opt.tabstop = 2
vim.opt.shiftwidth = 2
vim.opt.expandtab = true

vim.opt.hlsearch = true
vim.opt.list = true
vim.opt.listchars = { tab = ">-" }
vim.opt.wrap = false
vim.opt.mouse = "v"

vim.opt.errorbells = false
vim.opt.visualbell = false
vim.opt.belloff = "all"

vim.opt.termguicolors = true
vim.opt.clipboard = "unnamedplus"
vim.opt.signcolumn = "auto"

-- ============================================================
-- Keymaps 
-- ============================================================
local map = vim.keymap.set

map("n", "<F7>",  "<cmd>enew<CR>", { silent = true })
map("n", "<F8>",  "<cmd>bprevious<CR>", { silent = true })
map("n", "<F9>",  "<cmd>bnext<CR>", { silent = true })
map("n", "<F10>", "<cmd>bp | bd #<CR>", { silent = true })

map("n", "<Space>", "<cmd>nohlsearch<CR>", { silent = true })
map("n", "ä", "<cmd>silent! %yank +<CR>", { silent = true })

-- ============================================================
-- Plugins: lazy.nvim bootstrap 
-- ============================================================
local lazypath = vim.fn.stdpath("data") .. "/lazy/lazy.nvim"
if not vim.loop.fs_stat(lazypath) then
  vim.fn.system({
    "git", "clone", "--filter=blob:none",
    "https://github.com/folke/lazy.nvim.git",
    "--branch=stable",
    lazypath
  })
end
vim.opt.rtp:prepend(lazypath)

-- ============================================================
-- Plugins 
-- ============================================================
require("lazy").setup({
  {
    "nvim-tree/nvim-tree.lua",
    dependencies = { "nvim-tree/nvim-web-devicons" },
    config = function()
      require("nvim-tree").setup({
        view = { width = 60 },
        filters = { dotfiles = false },
        git = { enable = true },
        actions = { open_file = { quit_on_open = true } },
      })
    end,
  },

  {
    "nvim-lualine/lualine.nvim",
    dependencies = { "nvim-tree/nvim-web-devicons" },
    config = function()
      require("lualine").setup({ options = { icons_enabled = true } })
    end,
  },

  -- keep ONE theme only (avoid duplicate theme ecosystems on old NVIM)
  { "maxmx03/solarized.nvim", lazy = false, priority = 1000 },

  { "alker0/chezmoi.vim", lazy = false },
})

-- ============================================================
-- Cheat Sheet 
-- ============================================================
vim.api.nvim_create_autocmd("VimEnter", {
  callback = function()
    if vim.fn.argc() == 0 then
      vim.cmd("edit ~/.config/nvim/cheatsheet.md")
    end
  end,
})

-- ============================================================
-- Theme 
-- ============================================================
require("solarized").setup({ variant = "dark" })
vim.cmd.colorscheme("solarized")
vim.o.background = "dark"

vim.api.nvim_set_hl(0, "Normal",   { bg = "#002b36", fg = "#839496" })
vim.api.nvim_set_hl(0, "NormalNC", { bg = "#002b36" })
vim.api.nvim_set_hl(0, "Visual",   { bg = "#586e75", fg = "#002b36" })
vim.api.nvim_set_hl(0, "VisualNOS",{ bg = "#586e75", fg = "#002b36" })
vim.api.nvim_set_hl(0, "Cursor",   { fg = "#002b36", bg = "#93a1a1" })

-- ============================================================
-- nvim-tree toggle 
-- ============================================================
local function my_tree_toggle()
  local ft = vim.bo.filetype
  if ft == "NvimTree" then
    vim.cmd("NvimTreeToggle")
  else
    vim.cmd("NvimTreeFindFile")
  end
end
vim.keymap.set("n", "<C-n>", my_tree_toggle, { silent = true })

-- ============================================================
-- Comment madness deactivated 
-- ============================================================
vim.api.nvim_create_autocmd("FileType", {
  pattern = "*",
  callback = function()
    vim.opt_local.formatoptions:remove({ "r", "o" })
  end,
})

{{- else -}}
-- ~/.config/nvim/init.lua (fallback)
vim.g.mapleader = " "
vim.opt.number = true
{{- end -}}
